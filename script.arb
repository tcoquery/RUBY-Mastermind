class String
  def bg_black;       "\e[40m#{self}\e[0m" end
  def bg_gray;        "\e[47m#{self}\e[0m" end
  def bg_red;         "\e[41m#{self}\e[0m" end
  def bg_green;       "\e[42m#{self}\e[0m" end
  def bg_brown;       "\e[43m#{self}\e[0m" end
  def bg_blue;        "\e[44m#{self}\e[0m" end
  def bg_magenta;     "\e[45m#{self}\e[0m" end
  def bg_cyan;        "\e[46m#{self}\e[0m" end
end

class Game < String

  def initialize
    banner
    rules
    @colors = ["1", "2", "3", "4", "5", "6"].shuffle
    @remaining_combination = []
    @remaining_numbers = []
    @clues = []
    @game_over = false
    @turn = 0
    play
  end

  def banner
    puts "========================="
    puts "=======MASTERMIND========"
    puts "=========================\n\n"
  end

  def rules
    puts "The objective is to find the correct color and order combination."
    puts "\nThere are six colors : #{"  1  ".bg_red}#{"  2  ".bg_green}#{"  3  ".bg_blue}#{"  4  ".bg_brown}#{"  5  ".bg_magenta}#{"  6  ".bg_cyan}" 
    puts "\nThe combination is made up of four colors, each color can be present more \nthan once."
    puts "\nEach round, you get clues:" 
    puts "\u25CF If you found a color but in the wrong position." 
    puts "\u25CB If you found a color in the right position."
  end

  def play
    check_endgame
    if @game_over
      return
    else
    round
    end
  end

  def round
    puts "\nTurn ##{@turn} : please enter a four-digit number to make your guess"
    @user_guess = gets.chomp
      if @user_guess.match?(/^[1-6][1-6][1-6][1-6]$/)
        check_correct_position(@user_guess.split(""))
        check_wrong_position
        play
      else
        error
      end
  end

  def check_correct_position(user_guess)
    @combined_combinations = @colors[0..3].zip(user_guess)
      @combined_combinations.each_with_index do |array, index| 
      if array[0]==array[1]
        @clues.push("\u25CB")
      else
        @remaining_numbers = @remaining_numbers.push(user_guess[index])
        @remaining_combination = @remaining_combination.push(@colors[index])
      end
    end
  end

  def check_wrong_position
    @remaining_numbers.each do |number|
      if @remaining_combination.include?(number)
        @clues.push("\u25CF")
        @remaining_combination.delete(number)
      end
    end
    puts @clues.join
  end

  def check_endgame
    if @clues.join == "\u25CB\u25CB\u25CB\u25CB"
      @game_over = true
      puts "Congratulations, you won !"
    elsif @turn > 11
      @game_over = true
      puts "You lost. The correct combination was #{@colors[0..3].join}."
    else
      @clues.clear
      @remaining_numbers.clear
      @remaining_combination.clear
      @turn +=1 
      
    end
  end

  def error
    puts "Erroneous input! Try again..."
    round
  end


end

Game.new